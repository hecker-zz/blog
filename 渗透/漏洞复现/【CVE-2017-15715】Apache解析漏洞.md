# 【CVE-2017-15715】Apache解析漏洞

### 漏洞描述

​	Apache HTTPD是一款HTTP服务器，它可以通过mod_php来运行PHP网页。其2.4.0-2.4.29版本中存在一个解析漏洞，在解析PHP时，1.phpx0a将被按照PHP后缀进行解析，导致绕过一些服务器的安全策略。

### 漏洞原理

- apache这次解析漏洞的根本原因是因为` $`，正则表达式中$是用来匹配字符串结尾的位置。如果设置了 RegExp 对象的 Multiline 属性，则 $ 也会匹配`\n`或`\r`。

- 如php的配置文件中包含了下面语句，则会把php、`\n`、`\r`结尾的文件，解析为php文件。从而导致漏洞发生。

  ```
  <FilesMatch \.php$>
  	SetHandler application/x-httpd-php
  ```

- 且还需要使用POST请求接收，因为POST请求不会去掉我们添加的`\n`或`\r`,而如果使用`$_FILES['file']['name']`去接收的话则会把我们的`\n`和`\r`去掉。

### 漏洞复现

| 机器位置 | IP                   |
| -------- | -------------------- |
| 攻击机   | 192.168.200.1        |
| 靶机     | 192.168.200.150:8080 |

- 使用docker启动靶场环境

  ![image-20240628144939761](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240628144939761.png)

- 打开靶机8080端口，查看到如下界面表示启动成功。

  ![image-20240628145042431](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240628145042431.png)

- 开启BurpSuit上传一个webshell并抓包拦截。

  ![image-20240628145149159](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240628145149159.png)

- 先尝试直接上传，提示bad file。

  ![image-20240628150125226](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240628150125226.png)

- 尝试在文件名后添加`0a`，就是`\n`的十六进制编码,添加到文件名后即可。

  ![image-20240628145724469](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240628145724469.png)

- 点击发送后，显示200状态码表示上传成功

  ![image-20240628145934336](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240628145934336.png)